---
layout: post
title: "[db] ARIES"
subtitle: 
author: "Dongbo"
header-style: text
mathjax: true
hidden: false
tags:
  - database
---

大概是七八月的时候水知乎时候在[谭神][1]的回答里找到了这个[Reading Lsit][2]，不知道又怎么样摸到了一篇关于 ARIES 简短的 morning paper 但是一直没看；后来组里分享 Aurora 时候老大提了一嘴“它实现的不是标准的 ARIES ”类似的话，让我终于下定决心要抽空了解一下 ARIES 究竟是如何实现的。

原论文很长，有六七十页，所以决定这里就看 [morning paper][3] 精简的内容粗略了解一下；开头介绍 ARIES 就是数据库教材里那种非常典型的基于日志的故障恢复系统（No Force，Steal），甚至说教材里介绍的日志系统不过是对 ARIES 功能的简化描述。

基于这些了解，我们开始这次的学习。

> 其实也就是对 morning paper 内容的再编辑和概括啦

首先 ARIES 使用日志来记录事务所有执行的操作，用于故障恢复时的重做和回滚；日志是 append-only 的，并且每条日志都带着一个日志序列号（Log Sequence Number，LSN）作为日志的标识符。日志会先在内存中缓存到一定数量后，再持久化到硬盘上，但是一定保证事务提交前该事务对应的所有日志都已持久化完毕（WAL）。

> Q: 为何先写日志，而不是等到写完数据再回复已经提交？  
A: 日志只需要写入实际改动数据对应的日志，且写日志是连续写；写数据可能是随机写（//但如果存储使用 LSM Tree 是否有区别//），而且改动一个 page 中一小部分数据就需要写入整个 page；这两项区别导致写日志更快。

<!-- 在故障恢复时，我们需要做一些redo和undo工作，morning paper 只简单介绍说 ARIES 中可能包含 redo log 和 undo log，但是何时需要写 redo 和 undo log 以及这些 log 的大概格式这里并不清楚。 -->

ARIES 中有 *compensation log record(CLR)*，用于回滚修改 
从例子上看，似乎是用于记录 partial rollback 的回滚操作（比如回滚到上一个checkpoint。
<!-- // TODO：这里说CLS是 redo-only log records，为啥？哪里还有redo only/undo only log 的说法？  -->
<!-- // 似乎就是之前记录的那个在回滚操作时记录的 log，这保证在 restart 过程中如果再次故障依然能正确恢复原有数据； -->

> Force: 事务提交前**必须**将所有修改过的 page 持久化；该策略下已提交事务不需要redo操作。  
No Force：不需要在提交时持久化所有 page，允许事务提交时只写入一部分 page，空闲时完成剩余部分page的持久化；若持久化所有page之前系统故障，可以通过WAL完成数据恢复。

> Steal： 活跃事务可以在提交前持久化一部分已被修改的page；
No Steal：活跃事务修改的page**不允许**在提交前持久化；优点在于rollback时不需要进行undo操作。No Steal不适合大量更新事务的原因是，该策略可能使缓冲区被已经修改的页面占满，导致事务无法继续执行，因此大部分系统使用的都是 Steal 策略。

> 目前大部分数据库都选择 no force + steal 策略，这能提供最好的运行性能，代价是出现故障时恢复数据比 force 策略慢，但同样能保证数据的正确性。由于我们假设出现故障的概率较小，因此选择 no force 策略保证运行性能是更优的选择。

ARIES 需要定期记录 checkpoint，记录活跃事务、对应的LSN、事务在缓存中的脏数据。
// TODO: 好像事务持有的锁也需要记录？

// TODO:  ARIES 的 prepare record？ 记录 update-type locks（IX,X,SIX， etc.）？ // 教材提到的这些类型的锁果然就是 ARIES 的简化吧
// 什么是 prepare record？--> 2PC 
Aries 也用的是 2PC？（应该不会跟分布式提交的2PC完全相同，看看有哪些不一样的地方）

Aries 的故障恢复分为三个阶段：

1. Analysis。这一阶段从最后一个checkpoint开始扫描日志到文件末尾，找到需要重做的LSN、需要回滚的事务
2. Redo。这一阶段重做那些已经写入日志、但未持久化到磁盘的 update 操作。
3. Undo。（具体怎么操作？

### fuzzy checkpoint in Aries

先写入一条 checkpoint 日志记录，
（跟教材上的区别？


// Media Recovery 没有具体看

---------


总结来看，Aries比起教材介绍的故障恢复机制，多使用了LSN加快redo的速度、添加了LOCK的记录帮助保证重做时的隔离性。
// 仅仅是redo吗？

-----------------

The End

[1]: https://www.zhihu.com/people/tan-xin-yu-22/answers
[2]: https://github.com/heidihoward/distributed-consensus-reading-list
[3]: https://blog.acolyer.org/2016/01/08/aries/
[4]: